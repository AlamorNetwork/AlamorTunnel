{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-5 position-relative">
    <div class="position-absolute top-50 start-0 translate-middle-y" style="width: 5px; height: 100%; background: var(--primary-neon); box-shadow: 0 0 15px var(--primary-neon);"></div>
    <h2 class="fw-bold text-white ps-4 m-0" style="text-shadow: 0 0 10px rgba(255,255,255,0.2);">
        <i class="fas fa-network-wired me-3 text-primary-neon"></i>ACTIVE LINKAGES
    </h2>
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-glass">
        <i class="fas fa-plus-circle me-2"></i>INITIATE NEW
    </a>
</div>

<div class="glass-card p-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table mb-0 align-middle" style="color: #ccc;">
            <thead style="background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);">
                <tr class="text-uppercase small font-monospace" style="letter-spacing: 1px; color: var(--primary-neon);">
                    <th class="ps-4 py-3 border-0">Identifier</th>
                    <th class="py-3 border-0">Node Name</th>
                    <th class="py-3 border-0">Protocol</th>
                    <th class="py-3 border-0">Port</th>
                    <th class="text-end pe-4 py-3 border-0">Operations</th>
                </tr>
            </thead>
            <tbody>
                {% for tunnel in tunnels %}
                <tr style="transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td class="ps-4 border-0 font-monospace text-muted">#{{ tunnel.id }}</td>
                    <td class="border-0 fw-bold text-white">{{ tunnel.name }}</td>
                    <td class="border-0">
                        {% if 'hysteria' in tunnel.transport %}
                            <span class="badge bg-transparent border border-danger text-danger shadow-sm">HYSTERIA</span>
                        {% elif 'rathole' in tunnel.transport %}
                            <span class="badge bg-transparent border border-warning text-warning shadow-sm">RATHOLE</span>
                        {% elif 'gost' in tunnel.transport %}
                            <span class="badge bg-transparent border border-success text-success shadow-sm">GOST</span>
                        {% else %}
                            <span class="badge bg-transparent border border-info text-info shadow-sm">BACKHAUL</span>
                        {% endif %}
                    </td>
                    <td class="border-0 font-monospace" style="color: var(--secondary-neon);">{{ tunnel.port }}</td>
                    <td class="text-end pe-4 border-0">
                        <button class="btn btn-sm btn-outline-light rounded-circle me-1" onclick="openMonitor('{{tunnel.id}}', '{{tunnel.name}}')" title="Live Telemetry" style="width: 35px; height: 35px;">
                            <i class="fas fa-satellite-dish"></i>
                        </button>
                        
                        <a href="{{ url_for('tunnels.edit_tunnel', tunnel_id=tunnel.id) }}" class="btn btn-sm btn-outline-info rounded-circle me-1" title="Config" style="width: 35px; height: 35px;">
                            <i class="fas fa-microchip"></i>
                        </a>
                        <a href="{{ url_for('tunnels.delete_tunnel', tunnel_id=tunnel.id) }}" class="btn btn-sm btn-outline-danger rounded-circle" onclick="return confirm('Terminate this neural link?')" style="width: 35px; height: 35px;">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="opacity-25">
                            <i class="fas fa-wind fa-3x mb-3"></i>
                            <p class="font-monospace">NO ACTIVE SIGNALS DETECTED</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="monitorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title fw-bold text-white font-monospace">
                    <i class="fas fa-wave-square me-2 text-primary-neon"></i>TELEMETRY: <span id="monitorTitle" class="text-primary-neon"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="p-3 rounded border border-secondary border-opacity-25 text-center" style="background: rgba(0,0,0,0.4);">
                            <small class="text-muted text-uppercase font-monospace" style="font-size: 0.7rem;">Link Status</small>
                            <div class="mt-2 fw-bold fs-5" id="statusIndicator">
                                <span class="spinner-border spinner-border-sm text-muted"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded border border-secondary border-opacity-25 text-center" style="background: rgba(0,0,0,0.4);">
                            <small class="text-muted text-uppercase font-monospace" style="font-size: 0.7rem;">Latency</small>
                            <div class="mt-2 fw-bold fs-5 text-white" id="latencyDisplay" style="text-shadow: 0 0 10px white;">0 ms</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded border border-secondary border-opacity-25 text-center" style="background: rgba(0,0,0,0.4);">
                            <small class="text-muted text-uppercase font-monospace" style="font-size: 0.7rem;">Throughput</small>
                            <div class="mt-2 fw-bold fs-6 text-white font-monospace">
                                <i class="fas fa-arrow-up text-success me-1"></i><span id="txDisplay">0 B</span>
                                <span class="mx-2 text-muted">|</span>
                                <i class="fas fa-arrow-down text-info me-1"></i><span id="rxDisplay">0 B</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rounded p-3 border border-secondary border-opacity-25 mb-4 position-relative" style="background: rgba(0,0,0,0.6);">
                    <div class="position-absolute top-0 start-0 w-100 h-100" style="background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 20px 20px; z-index: 0; pointer-events: none;"></div>
                    <canvas id="trafficChart" height="100" class="position-relative z-1"></canvas>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-outline-light btn-sm font-monospace" onclick="runServerSpeedtest()">
                        <i class="fas fa-tachometer-alt me-2"></i>PING TEST
                    </button>
                    <small class="text-muted font-monospace" id="speedtestResult"></small>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ... (The rest of JS logic remains the same, just updating chart colors below) ...
let chartInstance = null;
let updateInterval = null;
let currentTunnelId = null;

function formatBytes(bytes, decimals = 2) {
    if (!+bytes) return '0 B';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}

function openMonitor(id, name) {
    currentTunnelId = id;
    document.getElementById('monitorTitle').innerText = name;
    document.getElementById('statusIndicator').innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span>';
    document.getElementById('latencyDisplay').innerText = '-';
    document.getElementById('txDisplay').innerText = '0 B';
    document.getElementById('rxDisplay').innerText = '0 B';
    document.getElementById('speedtestResult').innerText = '';

    initChart();
    fetchStats();
    if (updateInterval) clearInterval(updateInterval);
    updateInterval = setInterval(fetchStats, 2000);

    new bootstrap.Modal(document.getElementById('monitorModal')).show();
}

function initChart() {
    const ctx = document.getElementById('trafficChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    // CYBERPUNK COLORS
    const gradientTx = ctx.createLinearGradient(0, 0, 0, 400);
    gradientTx.addColorStop(0, 'rgba(0, 243, 255, 0.5)'); // Cyan
    gradientTx.addColorStop(1, 'rgba(0, 243, 255, 0)');

    const gradientRx = ctx.createLinearGradient(0, 0, 0, 400);
    gradientRx.addColorStop(0, 'rgba(188, 19, 254, 0.5)'); // Purple
    gradientRx.addColorStop(1, 'rgba(188, 19, 254, 0)');

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(20).fill(''),
            datasets: [{
                label: 'TX (Upload)',
                borderColor: '#00f3ff', // Cyan Neon
                backgroundColor: gradientTx,
                borderWidth: 2,
                pointRadius: 0,
                data: Array(20).fill(0),
                tension: 0.4,
                fill: true
            }, {
                label: 'RX (Download)',
                borderColor: '#bc13fe', // Purple Neon
                backgroundColor: gradientRx,
                borderWidth: 2,
                pointRadius: 0,
                data: Array(20).fill(0),
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: { 
                legend: { labels: { color: '#fff', font: {family: 'Outfit'} } } 
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: 'rgba(255,255,255,0.05)' }, 
                    ticks: { color: '#888', font: {family: 'monospace'} } 
                },
                x: { display: false }
            },
            animation: false
        }
    });
}

let lastRx = 0; let lastTx = 0;

function fetchStats() {
    if (!currentTunnelId) return;

    fetch(`/tunnel/stats/${currentTunnelId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('txDisplay').innerText = formatBytes(data.tx_bytes);
            document.getElementById('rxDisplay').innerText = formatBytes(data.rx_bytes);
            document.getElementById('latencyDisplay').innerText = data.latency + ' ms';
            
            const statusEl = document.getElementById('statusIndicator');
            if (data.status === 'active') {
                statusEl.innerHTML = '<span class="text-success" style="text-shadow: 0 0 10px lime"><i class="fas fa-check-circle me-2"></i>LOCKED</span>';
            } else {
                statusEl.innerHTML = '<span class="text-danger" style="text-shadow: 0 0 10px red"><i class="fas fa-times-circle me-2"></i>DOWN</span>';
            }

            let deltaRx = data.rx_bytes - lastRx;
            let deltaTx = data.tx_bytes - lastTx;
            if (lastRx === 0) { deltaRx = 0; deltaTx = 0; }
            lastRx = data.rx_bytes; lastTx = data.tx_bytes;

            chartInstance.data.datasets[0].data.shift();
            chartInstance.data.datasets[1].data.shift();
            chartInstance.data.datasets[0].data.push(deltaTx);
            chartInstance.data.datasets[1].data.push(deltaRx);
            chartInstance.update();
        });
}

function runServerSpeedtest() {
    const resEl = document.getElementById('speedtestResult');
    resEl.innerHTML = '<span class="spinner-border spinner-border-sm me-2 text-secondary"></span>Analysing...';
    
    fetch('/server/speedtest')
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                resEl.innerHTML = `<span class="text-danger">Error: ${data.error}</span>`;
            } else {
                resEl.innerHTML = `<span class="text-success font-monospace">PING: ${data.ping} | DL: ${data.download} | UL: ${data.upload}</span>`;
            }
        });
}

document.getElementById('monitorModal').addEventListener('hidden.bs.modal', function () {
    if (updateInterval) clearInterval(updateInterval);
});
</script>
{% endblock %}