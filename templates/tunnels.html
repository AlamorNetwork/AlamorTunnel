{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-5 position-relative">
    <div class="position-absolute top-50 start-0 translate-middle-y" style="width: 5px; height: 100%; background: var(--primary-neon); box-shadow: 0 0 15px var(--primary-neon);"></div>
    <h2 class="fw-bold text-white ps-4 m-0" style="text-shadow: 0 0 10px rgba(255,255,255,0.2);">
        <i class="fas fa-network-wired me-3 text-primary-neon"></i>ACTIVE LINKAGES
    </h2>
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-glass">
        <i class="fas fa-plus-circle me-2"></i>INITIATE NEW
    </a>
</div>

<div class="glass-card p-0 overflow-hidden">
    <div class="table-responsive">
    <table class="table mb-0 align-middle"> 
        <thead style="background: rgba(0,0,0,0.4); border-bottom: 2px solid rgba(255,255,255,0.1);">
            <tr class="text-uppercase small font-monospace" style="letter-spacing: 1px;">
                <th class="ps-4 py-3 border-0">ID</th>
                <th class="py-3 border-0">Node Name</th>
                <th class="py-3 border-0">Protocol</th>
                <th class="py-3 border-0">Port</th>
                <th class="text-end pe-4 py-3 border-0">Operations</th>
            </tr>
        </thead>
        <tbody>
            {% for tunnel in tunnels %}
            <tr style="transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <td class="ps-4 border-0 font-monospace fw-bold text-white-50">#{{ tunnel['id'] }}</td>
                <td class="border-0 fw-bold fs-5">{{ tunnel['name'] }}</td>
                <td class="border-0">
                    {% if 'hysteria' in tunnel['transport'] %}
                        <span class="badge bg-danger bg-opacity-25 border border-danger text-danger shadow-sm px-3">HYSTERIA</span>
                    {% elif 'rathole' in tunnel['transport'] %}
                        <span class="badge bg-warning bg-opacity-25 border border-warning text-warning shadow-sm px-3">RATHOLE</span>
                    {% elif 'gost' in tunnel['transport'] %}
                        <span class="badge bg-success bg-opacity-25 border border-success text-success shadow-sm px-3">GOST</span>
                    {% else %}
                        <span class="badge bg-info bg-opacity-25 border border-info text-info shadow-sm px-3">BACKHAUL</span>
                    {% endif %}
                </td>
                <td class="border-0 font-monospace fs-5" style="color: var(--primary-neon); text-shadow: 0 0 5px var(--primary-neon);">{{ tunnel['port'] }}</td>
                <td class="text-end pe-4 border-0 py-3">
                    <button class="btn-icon-glow btn-monitor me-2" 
                            onclick="openMonitor('{{tunnel['id']}}', '{{tunnel['name']}}')" 
                            title="Live Telemetry">
                        <i class="fas fa-satellite-dish"></i>
                    </button>
                    
                    <a href="{{ url_for('tunnels.edit_tunnel', tunnel_id=tunnel['id']) }}" 
                       class="btn-icon-glow btn-config me-2" 
                       title="Config">
                        <i class="fas fa-microchip"></i>
                    </a>
                    
                    <a href="{{ url_for('tunnels.delete_tunnel', tunnel_id=tunnel['id']) }}" 
                       class="btn-icon-glow btn-delete" 
                       onclick="return confirm('Terminate this neural link?')" 
                       title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center py-5 text-white-50">
                    <div class="opacity-50">
                        <i class="fas fa-wind fa-3x mb-3"></i>
                        <p class="font-monospace fs-5">NO ACTIVE SIGNALS DETECTED</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<div class="modal fade" id="monitorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title fw-bold text-white font-monospace">
                    <i class="fas fa-wave-square me-2 text-primary-neon"></i>TELEMETRY: <span id="monitorTitle" class="text-primary-neon"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="p-3 rounded border border-secondary border-opacity-25 text-center" style="background: rgba(0,0,0,0.4);">
                            <small class="text-muted text-uppercase font-monospace" style="font-size: 0.7rem;">Link Status</small>
                            <div class="mt-2 fw-bold fs-5" id="statusIndicator">
                                <span class="spinner-border spinner-border-sm text-muted"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded border border-secondary border-opacity-25 text-center" style="background: rgba(0,0,0,0.4);">
                            <small class="text-muted text-uppercase font-monospace" style="font-size: 0.7rem;">Latency</small>
                            <div class="mt-2 fw-bold fs-5 text-white" id="latencyDisplay" style="text-shadow: 0 0 10px white;">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded border border-secondary border-opacity-25 text-center" style="background: rgba(0,0,0,0.4);">
                            <small class="text-muted text-uppercase font-monospace" style="font-size: 0.7rem;">Total Traffic</small>
                            <div class="mt-2 fw-bold fs-6 text-white font-monospace">
                                <span class="d-block"><i class="fas fa-arrow-up text-success me-1"></i><span id="txDisplay">0 B</span></span>
                                <span class="d-block"><i class="fas fa-arrow-down text-info me-1"></i><span id="rxDisplay">0 B</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rounded p-3 border border-secondary border-opacity-25 mb-4 position-relative" style="background: rgba(0,0,0,0.6);">
                    <div class="position-absolute top-0 start-0 w-100 h-100" style="background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 20px 20px; z-index: 0; pointer-events: none;"></div>
                    <canvas id="trafficChart" height="100" class="position-relative z-1"></canvas>
                </div>

                <div class="glass-card p-3 border border-secondary border-opacity-25">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-white m-0 font-monospace"><i class="fas fa-tachometer-alt me-2 text-warning"></i>NETWORK SPEEDTEST</h6>
                        <button class="btn btn-sm btn-glass text-uppercase" onclick="runServerSpeedtest()" id="btnSpeedtest">
                            START TEST
                        </button>
                    </div>
                    
                    <div id="speedtestResults" class="row g-2 text-center d-none">
                        <div class="col-4">
                            <div class="p-2 rounded bg-black bg-opacity-50 border border-secondary border-opacity-10">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">PING</small>
                                <span id="stPing" class="text-warning fw-bold font-monospace">...</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded bg-black bg-opacity-50 border border-secondary border-opacity-10">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">DOWNLOAD</small>
                                <span id="stDown" class="text-info fw-bold font-monospace">...</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded bg-black bg-opacity-50 border border-secondary border-opacity-10">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">UPLOAD</small>
                                <span id="stUp" class="text-success fw-bold font-monospace">...</span>
                            </div>
                        </div>
                        <div class="col-12 mt-2">
                             <small class="text-muted" id="stServer">Connecting...</small>
                        </div>
                    </div>
                    
                    <div id="speedtestLoader" class="text-center py-3 d-none">
                         <div class="spinner-border text-primary" role="status"></div>
                         <p class="text-white-50 small mt-2 blink">Running Network Analysis...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartInstance = null;
let updateInterval = null;
let currentTunnelId = null;
let lastRx = 0; 
let lastTx = 0;

// فرمت کردن بایت به مگابایت و ...
function formatBytes(bytes, decimals = 2) {
    if (!+bytes) return '0 B';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}

// باز کردن مودال
function openMonitor(id, name) {
    currentTunnelId = id;
    document.getElementById('monitorTitle').innerText = name;
    
    // ریست کردن مقادیر
    document.getElementById('statusIndicator').innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span>';
    document.getElementById('speedtestResults').classList.add('d-none');
    document.getElementById('speedtestLoader').classList.add('d-none');
    
    lastRx = 0; lastTx = 0;
    
    initChart();
    fetchStats();
    
    if (updateInterval) clearInterval(updateInterval);
    updateInterval = setInterval(fetchStats, 2000); // آپدیت هر ۲ ثانیه

    new bootstrap.Modal(document.getElementById('monitorModal')).show();
}

// ساخت نمودار
function initChart() {
    const ctx = document.getElementById('trafficChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    const gradientTx = ctx.createLinearGradient(0, 0, 0, 400);
    gradientTx.addColorStop(0, 'rgba(0, 243, 255, 0.4)');
    gradientTx.addColorStop(1, 'rgba(0, 243, 255, 0)');

    const gradientRx = ctx.createLinearGradient(0, 0, 0, 400);
    gradientRx.addColorStop(0, 'rgba(188, 19, 254, 0.4)');
    gradientRx.addColorStop(1, 'rgba(188, 19, 254, 0)');

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(15).fill(''), // ۱۵ نقطه زمانی
            datasets: [{
                label: 'Upload (TX)',
                borderColor: '#00f3ff',
                backgroundColor: gradientTx,
                borderWidth: 2,
                pointRadius: 0,
                data: Array(15).fill(0),
                tension: 0.4,
                fill: true
            }, {
                label: 'Download (RX)',
                borderColor: '#bc13fe',
                backgroundColor: gradientRx,
                borderWidth: 2,
                pointRadius: 0,
                data: Array(15).fill(0),
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#fff' } } },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: 'rgba(255,255,255,0.05)' }, 
                    ticks: { color: '#888' } 
                },
                x: { display: false }
            },
            animation: false // برای روانی آپدیت لایو
        }
    });
}

// دریافت اطلاعات زنده
function fetchStats() {
    if (!currentTunnelId) return;

    fetch(`/tunnel/stats/${currentTunnelId}`)
        .then(res => res.json())
        .then(data => {
            // آپدیت متن‌ها
            document.getElementById('txDisplay').innerText = formatBytes(data.tx_bytes);
            document.getElementById('rxDisplay').innerText = formatBytes(data.rx_bytes);
            document.getElementById('latencyDisplay').innerText = data.latency;
            
            const statusEl = document.getElementById('statusIndicator');
            if (data.status === 'active') {
                statusEl.innerHTML = '<span class="text-success" style="text-shadow: 0 0 10px lime"><i class="fas fa-check-circle me-2"></i>LOCKED</span>';
            } else {
                statusEl.innerHTML = '<span class="text-danger" style="text-shadow: 0 0 10px red"><i class="fas fa-times-circle me-2"></i>DOWN</span>';
            }

            // محاسبه سرعت لحظه‌ای برای نمودار
            // چون psutil ترافیک کل رو میده، ما اختلاف با مقدار قبلی رو حساب میکنیم
            let deltaRx = 0;
            let deltaTx = 0;
            
            if (lastRx !== 0) {
                deltaRx = data.rx_bytes - lastRx;
                deltaTx = data.tx_bytes - lastTx;
            }
            lastRx = data.rx_bytes;
            lastTx = data.tx_bytes;
            
            // جلوگیری از اعداد منفی (در صورت ریست شدن کانتر سیستم)
            if (deltaRx < 0) deltaRx = 0;
            if (deltaTx < 0) deltaTx = 0;

            // آپدیت نمودار
            chartInstance.data.datasets[0].data.shift();
            chartInstance.data.datasets[1].data.shift();
            chartInstance.data.datasets[0].data.push(deltaTx); // آپلود
            chartInstance.data.datasets[1].data.push(deltaRx); // دانلود
            chartInstance.update();
        });
}

// اجرای تست سرعت
function runServerSpeedtest() {
    const btn = document.getElementById('btnSpeedtest');
    const loader = document.getElementById('speedtestLoader');
    const results = document.getElementById('speedtestResults');
    
    btn.disabled = true;
    loader.classList.remove('d-none');
    results.classList.add('d-none');
    
    fetch('/server/speedtest')
        .then(res => res.json())
        .then(data => {
            loader.classList.add('d-none');
            results.classList.remove('d-none');
            btn.disabled = false;
            
            if (data.error) {
                document.getElementById('stServer').innerHTML = `<span class="text-danger">${data.error}</span>`;
            } else {
                document.getElementById('stPing').innerText = data.ping;
                document.getElementById('stDown').innerText = data.download;
                document.getElementById('stUp').innerText = data.upload;
                document.getElementById('stServer').innerText = data.server;
            }
        })
        .catch(err => {
            loader.classList.add('d-none');
            btn.disabled = false;
            alert("Connection Failed");
        });
}

// بستن مانیتورینگ
document.getElementById('monitorModal').addEventListener('hidden.bs.modal', function () {
    if (updateInterval) clearInterval(updateInterval);
});
</script>
{% endblock %}