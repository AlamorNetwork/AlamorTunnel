{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 mt-4">
    <h2 class="fw-bold text-white">Active Tunnels</h2>
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-primary-glow">New Tunnel</a>
</div>

<div class="glass-panel p-0">
    <table class="table table-dark table-hover mb-0 align-middle">
        <thead>
            <tr><th>Name</th><th>Type</th><th>Port</th><th class="text-end">Controls</th></tr>
        </thead>
        <tbody>
            {% for tunnel in tunnels %}
            <tr>
                <td class="fw-bold">{{ tunnel.name }}</td>
                <td><span class="badge bg-secondary">{{ tunnel.transport }}</span></td>
                <td>{{ tunnel.port }}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-light me-1" onclick="openMonitor('{{tunnel.id}}', '{{tunnel.name}}')"><i class="fas fa-chart-line"></i></button>
                    <a href="{{ url_for('tunnels.delete_tunnel', tunnel_id=tunnel.id) }}" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></a>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="text-center py-4">No tunnels.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="monitorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Monitor: <span id="monitorTitle" class="text-primary"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="p-3 bg-black bg-opacity-25 rounded border border-secondary text-center"><small class="text-muted">STATUS</small><div class="mt-1 fw-bold fs-5" id="statusIndicator">Checking...</div></div></div>
                    <div class="col-md-4"><div class="p-3 bg-black bg-opacity-25 rounded border border-secondary text-center"><small class="text-muted">LATENCY</small><div class="mt-1 fw-bold fs-5 text-white" id="latencyDisplay">-</div></div></div>
                    <div class="col-md-4"><div class="p-3 bg-black bg-opacity-25 rounded border border-secondary text-center"><small class="text-muted">TOTAL TRAFFIC</small><div class="mt-1 fw-bold fs-6 text-white"><span id="txDisplay">0 B</span> / <span id="rxDisplay">0 B</span></div></div></div>
                </div>
                <div class="bg-black bg-opacity-25 rounded p-3 border border-secondary mb-4"><canvas id="trafficChart" height="100"></canvas></div>
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-outline-light btn-sm" onclick="runServerSpeedtest()">Test Server Speed</button>
                    <small class="text-muted" id="speedtestResult"></small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let chartInstance = null;
let updateInterval = null;
let currentTunnelId = null;

function formatBytes(bytes) {
    if (!+bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
}

function openMonitor(id, name) {
    currentTunnelId = id;
    document.getElementById('monitorTitle').innerText = name;
    if (chartInstance) chartInstance.destroy();
    
    const ctx = document.getElementById('trafficChart').getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(20).fill(''),
            datasets: [
                { label: 'Upload', borderColor: '#10b981', data: Array(20).fill(0), tension: 0.4 },
                { label: 'Download', borderColor: '#3b82f6', data: Array(20).fill(0), tension: 0.4 }
            ]
        },
        options: { responsive: true, animation: false, scales: { x: { display: false } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
    });

    if (updateInterval) clearInterval(updateInterval);
    updateInterval = setInterval(fetchStats, 2000);
    new bootstrap.Modal(document.getElementById('monitorModal')).show();
}

let lastRx = 0; let lastTx = 0;
function fetchStats() {
    fetch(`/tunnel/stats/${currentTunnelId}`).then(res => res.json()).then(data => {
        document.getElementById('txDisplay').innerText = formatBytes(data.tx_bytes);
        document.getElementById('rxDisplay').innerText = formatBytes(data.rx_bytes);
        document.getElementById('latencyDisplay').innerText = data.latency + ' ms';
        document.getElementById('statusIndicator').innerHTML = data.status === 'active' ? '<span class="text-success">Connected</span>' : '<span class="text-danger">Disconnected</span>';
        
        let deltaRx = data.rx_bytes - lastRx;
        let deltaTx = data.tx_bytes - lastTx;
        if (lastRx === 0) { deltaRx = 0; deltaTx = 0; }
        lastRx = data.rx_bytes; lastTx = data.tx_bytes;

        chartInstance.data.datasets[0].data.shift(); chartInstance.data.datasets[0].data.push(deltaTx);
        chartInstance.data.datasets[1].data.shift(); chartInstance.data.datasets[1].data.push(deltaRx);
        chartInstance.update();
    });
}

function runServerSpeedtest() {
    document.getElementById('speedtestResult').innerText = 'Testing...';
    fetch('/server/speedtest').then(res => res.json()).then(data => {
        document.getElementById('speedtestResult').innerText = data.error ? data.error : `Ping: ${data.ping} | DL: ${data.download} | UL: ${data.upload}`;
    });
}

document.getElementById('monitorModal').addEventListener('hidden.bs.modal', function () { if (updateInterval) clearInterval(updateInterval); });
</script>
{% endblock %}