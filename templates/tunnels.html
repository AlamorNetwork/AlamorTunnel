{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-4">
    <h2 class="h3 fw-bold" style="color: var(--primary-color);">Active Tunnels</h2>
</div>

<div class="row">
    <div class="col-12">
        {% if tunnel %}
        <div class="glass-panel p-0 overflow-hidden">
            <div class="p-4 border-bottom" style="border-color: var(--glass-border) !important;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h4 class="mb-1 text-main">{{ tunnel.name }}</h4>
                        <span class="badge bg-primary">{{ tunnel.transport.upper() }}</span>
                        <span class="badge bg-secondary">Port: {{ tunnel.port }}</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-info" onclick="runTest('speed')"><i class="fa-solid fa-gauge"></i> Speed Test</button>
                        <button class="btn btn-sm btn-outline-success" onclick="runTest('download')"><i class="fa-solid fa-download"></i> DL Test</button>
                        <a href="{{ url_for('delete_tunnel') }}" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i> Delete</a>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-opacity-10 bg-black">
                <h6 class="text-muted mb-3">Configuration Details</h6>
                <div class="row g-3 font-monospace small">
                    <div class="col-md-12">
                        <div class="p-3 rounded" style="background: rgba(0,0,0,0.3);">
                            <pre class="mb-0 text-success">{{ tunnel.config | tojson(indent=2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="glass-panel p-5 text-center">
            <i class="fa-solid fa-wind fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Active Tunnels</h5>
            <a href="{{ url_for('dashboard') }}" class="btn btn-alamor mt-3">Create Tunnel</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel" style="background: var(--sidebar-bg);">
            <div class="modal-body text-center p-4">
                <div id="testSpinner" class="spinner-border text-primary mb-3" role="status"></div>
                <h5 id="testTitle" class="mb-2">Running Test...</h5>
                <p id="testResult" class="text-muted mb-0">Please wait while we check the tunnel health.</p>
                <button type="button" class="btn btn-sm btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function runTest(type) {
        const modal = new bootstrap.Modal(document.getElementById('testModal'));
        const spinner = document.getElementById('testSpinner');
        const title = document.getElementById('testTitle');
        const result = document.getElementById('testResult');
        
        modal.show();
        spinner.style.display = 'inline-block';
        title.innerText = type === 'speed' ? 'Checking Latency...' : 'Testing Download...';
        result.innerText = 'Communicating with foreign server...';

        fetch(`/test-tunnel/${type}`)
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                title.innerText = 'Result';
                result.innerText = data.msg;
                title.className = 'mb-2 text-success';
            })
            .catch(err => {
                spinner.style.display = 'none';
                title.innerText = 'Error';
                result.innerText = 'Failed to connect.';
                title.className = 'mb-2 text-danger';
            });
    }
</script>
{% endblock %}