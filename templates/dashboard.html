{% extends "base.html" %}
{% block content %}

<script>
function startInstall(protocol, formId) {
    const form = document.getElementById(formId);
    const formData = new FormData(form);
    
    // بستن مودال کانفیگ
    bootstrap.Modal.getInstance(form.closest('.modal')).hide();
    
    // باز کردن مودال پیشرفت
    new bootstrap.Modal(document.getElementById('progressModal')).show();

    // ارسال درخواست
    fetch(`/start-install/${protocol}`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'started') {
            trackProgress(data.task_id);
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function trackProgress(taskId) {
    const bar = document.getElementById('progressBar');
    const log = document.getElementById('progressLog');
    
    const interval = setInterval(() => {
        fetch(`/task-status/${taskId}`)
        .then(res => res.json())
        .then(data => {
            bar.style.width = data.progress + '%';
            log.innerText = data.log;

            if(data.status === 'completed') {
                clearInterval(interval);
                bar.classList.replace('bg-primary', 'bg-success');
                document.getElementById('completionBtn').classList.remove('d-none');
            }
        });
    }, 1000);
}
</script>
{% endblock %}