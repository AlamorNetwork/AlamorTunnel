{% extends "base.html" %}

{% block content %}
<div class="card p-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5 class="text-muted">Foreign Server Status</h5>
            {% if server_ip %}
                <h2 class="text-success fw-bold"><i class="fas fa-check-circle"></i> Connected</h2>
                <span class="badge bg-secondary">{{ server_ip }}</span>
            {% else %}
                <h2 class="text-danger fw-bold"><i class="fas fa-times-circle"></i> Disconnected</h2>
            {% endif %}
        </div>
        <div>
            {% if not server_ip %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#connectModal">
                    <i class="fas fa-plug"></i> Connect Server
                </button>
            {% else %}
                <a href="{{ url_for('dashboard.disconnect_server') }}" class="btn btn-outline-danger">
                    Disconnect
                </a>
            {% endif %}
        </div>
    </div>
</div>

<h4 class="mb-3 mt-4">Install Tunnels</h4>
<div class="row">
    
    <div class="col-md-3">
        <div class="card text-center p-3 h-100">
            <div class="card-body">
                <i class="fas fa-bolt fa-3x text-primary mb-3"></i>
                <h5>Hysteria 2</h5>
                <p class="text-muted small">UDP Optimized for bad networks</p>
                <button class="btn btn-primary w-100 btn-custom" data-bs-toggle="modal" data-bs-target="#hysteriaModal">Install</button>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-center p-3 h-100">
            <div class="card-body">
                <i class="fas fa-wind fa-3x text-info mb-3"></i>
                <h5>Slipstream (Rust)</h5>
                <p class="text-muted small">High-Speed DNS/QUIC Tunnel</p>
                <button class="btn btn-info text-white w-100 btn-custom" data-bs-toggle="modal" data-bs-target="#slipstreamModal">Install</button>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-center p-3 h-100">
            <div class="card-body">
                <i class="fas fa-mouse fa-3x text-success mb-3"></i>
                <h5>Rathole</h5>
                <p class="text-muted small">Lightweight NAT Traversal</p>
                <button class="btn btn-success w-100 btn-custom" data-bs-toggle="modal" data-bs-target="#ratholeModal">Install</button>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-center p-3 h-100">
            <div class="card-body">
                <i class="fas fa-server fa-3x text-secondary mb-3"></i>
                <h5>Backhaul</h5>
                <p class="text-muted small">Standard TCP Tunnel</p>
                <button class="btn btn-secondary w-100 btn-custom" data-bs-toggle="modal" data-bs-target="#backhaulModal">Install</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="connectModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{{ url_for('dashboard.connect_server') }}" method="POST" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Connect to Foreign Server</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="text" name="ip" class="form-control mb-2" placeholder="IP Address" required>
                <input type="text" name="username" class="form-control mb-2" value="root" required>
                <input type="password" name="password" class="form-control mb-2" placeholder="Password" required>
                <input type="number" name="port" class="form-control" value="22" required>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">Connect</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="hysteriaModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{{ url_for('tunnels.install_hysteria') }}" method="POST" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Install Hysteria 2</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label>Tunnel Port (UDP)</label>
                <input type="number" name="tunnel_port" class="form-control mb-2" placeholder="e.g. 443" required>
                <label>Forward Ports</label>
                <input type="text" name="forward_ports" class="form-control mb-2" placeholder="8443, 2080" required>
                <div class="row">
                    <div class="col"><input type="number" name="up_mbps" class="form-control" placeholder="Up Mbps" value="100"></div>
                    <div class="col"><input type="number" name="down_mbps" class="form-control" placeholder="Down Mbps" value="100"></div>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">Install</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="slipstreamModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{{ url_for('tunnels.install_slipstream') }}" method="POST" class="modal-content">
            <div class="modal-header bg-info text-white"><h5 class="modal-title">Install Slipstream</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="alert alert-warning small">Building Rust takes 5-10 minutes. Please wait.</div>
                <label>Tunnel Port (UDP/DNS)</label>
                <input type="number" name="tunnel_port" class="form-control mb-2" value="8853" required>
                <label>Iran Listen Port</label>
                <input type="number" name="client_port" class="form-control mb-2" value="8443" required>
                <label>Dest Port (Xray)</label>
                <input type="number" name="dest_port" class="form-control mb-2" value="8443" required>
                <label>Fake Domain</label>
                <input type="text" name="domain" class="form-control" value="update.googleapis.com" required>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-info text-white">Build & Install</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="ratholeModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{{ url_for('tunnels.install_rathole') }}" method="POST" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Install Rathole</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label>Tunnel Port</label>
                <input type="number" name="tunnel_port" class="form-control mb-2" required>
                <label>Forward Ports</label>
                <input type="text" name="forward_ports" class="form-control mb-2" placeholder="8080, 443" required>
                <label>Transport</label>
                <select name="transport" class="form-select">
                    <option value="tcp">TCP</option>
                    <option value="udp">UDP</option>
                </select>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">Install</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="backhaulModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{{ url_for('tunnels.install_backhaul') }}" method="POST" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Install Backhaul</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label>Tunnel Port</label>
                <input type="number" name="tunnel_port" class="form-control mb-2" required>
                <select name="transport" class="form-select">
                    <option value="tcp">TCP</option>
                    <option value="ws">WebSocket</option>
                </select>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-secondary">Install</button></div>
        </form>
    </div>
</div>
{% endblock %}